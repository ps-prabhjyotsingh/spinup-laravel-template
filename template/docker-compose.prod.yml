services:
  mariadb:
    image: mariadb:12
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_DATABASE}
      MARIADB_USER: ${DB_USERNAME}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mariadb-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      laravelapp-network:
        aliases:
          - db

    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --innodb-buffer-pool-size=256000000
      --max-connections=500
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=5
      --max_allowed_packet=256000000
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 10
        window: 120s

  redis:
    image: redis:7-alpine
    command:
      - sh
      - -c
      - |
        redis-server --appendonly yes --save "60 1" $${REDIS_PASSWORD:+--requirepass "$$REDIS_PASSWORD"}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      - laravelapp-network
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 10
        window: 120s

#  phpmyadmin:
#    image: linuxserver/phpmyadmin
##    ports:
##      - "8080:80"
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    environment:
#      PMA_HOST: db
#      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
#    networks:
#      - inbound
#      - laravelapp-network
#    deploy:
#      replicas: 1
#      update_config:
#        failure_action: rollback
#        parallelism: 1
#        delay: 5s
#        order: start-first
#      restart_policy:
#        condition: any
#        delay: 10s
#        max_attempts: 3
#        window: 120s
#      labels:
#        - "traefik.enable=true"
#        - "traefik.http.routers.appmyadmin.rule=Host(`${PHPMYADMIN_DOMAIN}`)"
#        - "traefik.http.routers.appmyadmin.entrypoints=websecure"
#        - "traefik.http.routers.appmyadmin.tls=true"
#        #        - "traefik.http.routers.appmyadmin.tls.certresolver=letsencryptresolver"
#        - "traefik.http.services.appmyadmin.loadbalancer.server.port=80"
#        - "traefik.http.services.appmyadmin.loadbalancer.server.scheme=http"
#    depends_on:
#      - mariadb
#

  php:
    image: ${SPIN_IMAGE_DOCKERFILE} # ðŸ‘ˆ Change this if you're not using `spin deploy`
    environment:
      PHP_OPCACHE_ENABLE: "1"
      AUTORUN_ENABLED: "true" # ðŸ‘ˆ Remove this line if you don't want Laravel Automations
      APP_ENV: "${SPIN_DEPLOYMENT_ENVIRONMENT}" # ðŸ‘ˆ Remove this if you're not using `spin deploy`
      HEALTHCHECK_PATH: "/up" # Use Laravel's built-in health route
      #SSL_MODE: full
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
#      REDIS_HOST: ${REDIS_HOST}
#      REDIS_PORT: ${REDIS_PORT}
#      REDIS_PASSWORD: ${REDIS_PASSWORD}
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/up || nc -z localhost 9000 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    depends_on:
      - mariadb
    networks:
      - laravelapp-network
      - inbound
    volumes:
      - "storage_private:/var/www/html/storage/app/private/"
      - "storage_public:/var/www/html/storage/app/public/"
      - "storage_sessions:/var/www/html/storage/framework/sessions"
      - "storage_logs:/var/www/html/storage/logs"
      - "database_sqlite:/var/www/html/.infrastructure/volume_data/sqlite"
    deploy:
      replicas: 1
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 5s
        order: start-first
      rollback_config:
        parallelism: 0
        order: stop-first
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.laravelapp.rule=Host(`${SPIN_APP_DOMAIN}`)"
        - "traefik.http.routers.laravelapp.entrypoints=websecure"
        - "traefik.http.routers.laravelapp.tls=true"
#        - "traefik.http.routers.laravelapp.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.laravelapp.loadbalancer.server.port=8080"
        - "traefik.http.services.laravelapp.loadbalancer.server.scheme=http"
        # Health check
        - "traefik.http.services.laravelapp.loadbalancer.healthcheck.path=/up"
        - "traefik.http.services.laravelapp.loadbalancer.healthcheck.interval=30s"
        - "traefik.http.services.laravelapp.loadbalancer.healthcheck.timeout=5s"
        - "traefik.http.services.laravelapp.loadbalancer.healthcheck.scheme=http"

  queue:
    image: ${SPIN_IMAGE_DOCKERFILE}
    command: php artisan queue:work --sleep=3 --timeout=120 --tries=3
    environment:
      PHP_OPCACHE_ENABLE: "1"
      APP_ENV: ${SPIN_DEPLOYMENT_ENVIRONMENT:-production}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-database}
#      REDIS_HOST: ${REDIS_HOST}
#      REDIS_PORT: ${REDIS_PORT}
#      REDIS_PASSWORD: ${REDIS_PASSWORD}
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
    healthcheck:
      test: [ "CMD", "healthcheck-queue" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - mariadb
    networks:
      - laravelapp-network
#      - inbound
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 10
        window: 120s
      resources:
        limits:
          cpus: "0.50"
          memory: 512M
        reservations:
          cpus: "0.10"
          memory: 128M

#  reverb:
#    image: ${SPIN_IMAGE_DOCKERFILE}
#    command: php artisan reverb:start --host=0.0.0.0 --port=8080
#    environment:
#      APP_ENV: ${SPIN_DEPLOYMENT_ENVIRONMENT:-production}
#      BROADCAST_CONNECTION: reverb
#      REVERB_HOST: ${REVERB_HOST}
#      REVERB_PORT: ${REVERB_PORT}
#      REVERB_SCHEME: ${REVERB_SCHEME}
#      REDIS_HOST: ${REDIS_HOST}
#      REDIS_PORT: ${REDIS_PORT}
#      REDIS_PASSWORD: ${REDIS_PASSWORD}
#    expose:
#      - "8080"
#    networks:
##      - laravelapp-network
#      - inbound
#    deploy:
#      mode: replicated
#      replicas: 1
#      restart_policy:
#        condition: on-failure
#        delay: 5s
#        max_attempts: 10
#        window: 120s
#      resources:
#        limits:
#          cpus: "0.50"
#          memory: 512M
#        reservations:
#          cpus: "0.10"
#          memory: 128M
#      labels:
#        - "traefik.enable=true"
#        - "traefik.http.routers.laravelreverb.rule=Host(`${REVERB_HOST}`)"
#        - "traefik.http.routers.laravelreverb.entrypoints=websecure"
#        - "traefik.http.routers.laravelreverb.tls=true"
##        - "traefik.http.routers.laravelreverb.tls.certresolver=letsencryptresolver"
#        - "traefik.http.services.laravelreverb.loadbalancer.server.port=8080"

volumes:
  storage_private:
  storage_public:
  storage_sessions:
  storage_logs:
  database_sqlite:
  mariadb-data:
  redis-data:

networks:
  laravelapp-network:
  inbound:
    external: true
